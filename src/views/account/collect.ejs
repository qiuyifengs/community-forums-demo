<!DOCTYPE html>
<html>
    <head>
        <title><%= title %></title>
        <link rel="stylesheet" href="/style/account/posts.css">
        <% include ../common/script %>
    </head>
    <body>
        <div class="ghost-layout">
            <% include ../common/header %>
            <div class="ghost-pro-layouts-basic-layout-content ghost-layout-content">
                <div class="ghost-row ghost-row-flex">
                    <% include ./list %>
                    <section class="ghost-col-xs-24 ghost-col-sm-20 ghost-col-lg-20 ghost-col-xl-20 account-item">
                        <div class="ghost-card">
                            <div class="ghost-card-head bd-bottom">
                                <div class="ghost-card-head-wrapper">
                                    <div class="ghost-card-head-title">
                                        <span>我的收藏</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ghost-card-body">
                                <div class="ghost-list ghost-list-vertical ghost-list-split">
                                    <div class="ghost-spin-nested-loading">
                                        <% collectList.articleList.forEach(function(item) {%>
                                        <div class="ghost-list-item collect-item bd-bottom">
                                            <div class="ghost-list-item-main list-box">
                                                <div class="ghost-list-item-main">
                                                    <div class="ghost-list-item-meta-content">
                                                        <div class="ghost-list-item-meta-content">
                                                            <h4 class="ghost-list-item-meta-title"><%= item.articleTitle %></h4>
                                                        </div>
                                                        <div class="ghost-list-item-meta-article-content"><%- item.articleContent %></div>
                                                    </div>
                                                    <ul class="ghost-list-item-action">
                                                        <li class="list-item">
                                                            <a>
                                                                <%= item.viewCount %> 阅读
                                                            </a>
                                                        </li>
                                                        <li class="list-item">
                                                            <span>
                                                                <%= item.commentCount %> 评论
                                                            </span>
                                                        </li>
                                                        <li class="list-item">
                                                            <span>
                                                                <%= item.collectCount %> 收藏
                                                            </span>
                                                        </li>
                                                        <li class="list-item">
                                                            <span>
                                                                <%= item.likeCount %> 喜欢
                                                            </span>
                                                        </li>
                                                        <li class="list-item">
                                                            <span class="time">
                                                                <%= item.publishTime %>
                                                            </span>
                                                        </li>
                                                        <% if (item.articleLabel) { %>
                                                        <li class="source-type">
                                                            <% item.articleLabel.forEach(function(labelItem) {%>
                                                            <span class="article-source bd-radius-3"><%= labelItem %></span>
                                                            <% }) %>
                                                        </li>
                                                        <% } %>
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="ghost-list-item-extra">
                                                <div class="ghost-list-item-id" style="display: none"><%= item.articleId %></div>
                                                <button style="width: 80px; font-size: 12px" class="ghost-btn ghost-btn-primary">取消收藏</button>
                                            </div>
                                        </div>
                                        <% }) %>   
                                    </div>
                                </div>
                            </div>
                            <% if (collectList.length > 0) { %>
                                <ul class="ghost-pagination article_page" style="margin: 24px 0; text-align: center"></ul>
                            <% } %>
                            <input type="hidden" id="totalPages" value="<%= collectList.total %>" style="display: none" />
                        </div>
                        <% if (collectList.length < 1) { %>
                            <div class="no_data">
                                <img src="/images/no_collect.png" alt=""><br />
                                暂无收藏
                            </div>
                        <% } %>
                    </section>
                </div>
                <div class="ghost-loading-mask" style="display: none">
                    <div class="ghost-loading-spinner">
                        <svg viewBox="25 25 50 50" class="circular"><circle cx="50" cy="50" r="20" fill="none" class="path"></circle></svg>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script type="text/javascript">
        $(function() {
            // init pagination config
            $('.ghost-pagination').pagination({
                total: document.getElementById('totalPages').value,
                // total: 100,
                pageSize: 10,
                current: 1,
                coping: true,
                isHide: true,
                callback: api => {
                    $('.ghost-loading-mask').css('display', 'block')
                    const currentPage = api.getCurrent()
                    const url = `account/collect/${$.cookie("userId")}/${currentPage}`;
                    myAjax('GET', url).then(res => {
                        if (res.code === 1) {
                            $("#myArticleTemplate").empty()
                            console.log(res)
                            res.articleList.forEach(item => {
                                $("#myArticleTemplate").append(renderCollectHtml(item))
                            })
                            setTimeout(function() {
                                $('.ghost-loading-mask').css('display', 'none')
                            }, 500) 
                        }
                    })
                }
            });
            // go to article detail
            $(".list-box").each(function() {
                $(this).on("click", function(event) {
                    event.stopPropagation();
                    articleId = $(this).next(".ghost-list-item-extra").find(".ghost-list-item-id").text();
                    const url = 'post/articleDetail/' + articleId;
                    myAjax("POST", "post/addView", { articleId: articleId, userId: $.cookie("userId") })
                    goPage(url);
                })
            });
            $(".time").each(function() {
                let resTime = formatDateFilter($(this).text())
                $(this).text(resTime)
            });
            $(".ghost-btn").each(function(event) {
                $(this).on("click", function(event) {
                    event.stopPropagation();
                    let itemId = $(this).prev().text();
                    let param = {
                        userId: $.cookie("userId"),
                        articleId: itemId
                    }
                    myAjax("POST", 'account/removeCollect', param).then((res) => {
                        if (res.code == 1) {
                            $(this).parents(".ghost-list-item").remove()
                        } else {
                            console.log(res.message)
                        }
                    })
                })
            })
        })
        function renderCollectHtml(item) {
            return `
                <div class="ghost-list-item collect-item bd-bottom">
                    <div class="ghost-list-item-main list-box">
                        <div class="ghost-list-item-main">
                            <div class="ghost-list-item-meta-content">
                                <div class="ghost-list-item-meta-content">
                                    <h4 class="ghost-list-item-meta-title">${ item.articleTitle }</h4>
                                </div>
                                <div class="ghost-list-item-meta-article-content">${ item.articleContent }</div>
                            </div>
                            <ul class="ghost-list-item-action">
                                <li class="list-item">
                                    <a>
                                        ${ item.viewCount } 阅读
                                    </a>
                                </li>
                                <li class="list-item">
                                    <span>
                                        ${ item.commentCount } 评论
                                    </span>
                                </li>
                                <li class="list-item">
                                    <span>
                                        ${ item.collectCount } 收藏
                                    </span>
                                </li>
                                <li class="list-item">
                                    <span>
                                        ${ item.likeCount } 喜欢
                                    </span>
                                </li>
                                <li class="list-item">
                                    <span class="time">
                                        ${ item.publishTime }
                                    </span>
                                </li>
                                ${ renderArticleLabel(item.articleLabel) }
                            </ul>
                        </div>
                    </div>
                    <div class="ghost-list-item-extra">
                        <div class="ghost-list-item-id" style="display: none">${ item.articleId }</div>
                        <button style="width: 80px; font-size: 12px" class="ghost-btn ghost-btn-primary">取消收藏</button>
                    </div>
                </div>
            `
        }
        function renderArticleLabel(item) {
            if (item && item.length > 0) { 
                let labelDom = '';
                item.split(',').forEach(labelItem => {
                    labelDom += `<span class="article-source bd-radius-3">${ labelItem }</span>`
                })
                return `<li class="source-type">
                    ${ labelDom }
                </li>`
            } else {
                return '';
            }
        }
    </script>
</html>



